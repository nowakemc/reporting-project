
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DuckDB Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .report-container {
            margin-top: 20px;
        }
        .chart-container {
            margin-bottom: 20px;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .stats-box {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">DuckDB Document Management Analyzer</h1>
        
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Database Connection
                    </div>
                    <div class="card-body">
                        <form id="db-connect-form">
                            <div class="mb-3">
                                <label for="db-file" class="form-label">Select DuckDB File</label>
                                <input class="form-control" type="file" id="db-file" accept=".duckdb,.db">
                            </div>
                            <button type="submit" class="btn btn-primary">Connect</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Database Info
                    </div>
                    <div class="card-body" id="db-info">
                        <p>Not connected to a database.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading report data...</p>
        </div>
        
        <div id="report-tabs" style="display: none;">
            <ul class="nav nav-tabs" id="reportTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="objects-tab" data-bs-toggle="tab" data-bs-target="#objects" type="button" role="tab">Objects</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="instances-tab" data-bs-toggle="tab" data-bs-target="#instances" type="button" role="tab">Instances</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="classifications-tab" data-bs-toggle="tab" data-bs-target="#classifications" type="button" role="tab">Classifications</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="paths-tab" data-bs-toggle="tab" data-bs-target="#paths" type="button" role="tab">Paths</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tags-tab" data-bs-toggle="tab" data-bs-target="#tags" type="button" role="tab">Tags</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">Services</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="permissions-tab" data-bs-toggle="tab" data-bs-target="#permissions" type="button" role="tab">Permissions</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">Messages</button>
                </li>
            </ul>
            <div class="tab-content" id="reportTabsContent">
                <div class="tab-pane fade show active" id="overview" role="tabpanel"></div>
                <div class="tab-pane fade" id="objects" role="tabpanel"></div>
                <div class="tab-pane fade" id="instances" role="tabpanel"></div>
                <div class="tab-pane fade" id="classifications" role="tabpanel"></div>
                <div class="tab-pane fade" id="paths" role="tabpanel"></div>
                <div class="tab-pane fade" id="tags" role="tabpanel"></div>
                <div class="tab-pane fade" id="services" role="tabpanel"></div>
                <div class="tab-pane fade" id="permissions" role="tabpanel"></div>
                <div class="tab-pane fade" id="messages" role="tabpanel"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const dbConnectForm = document.getElementById('db-connect-form');
            const dbInfo = document.getElementById('db-info');
            const reportTabs = document.getElementById('report-tabs');
            const loading = document.getElementById('loading');
            
            // Tab content elements
            const tabsContent = {
                overview: document.getElementById('overview'),
                objects: document.getElementById('objects'),
                instances: document.getElementById('instances'),
                classifications: document.getElementById('classifications'),
                paths: document.getElementById('paths'),
                tags: document.getElementById('tags'),
                services: document.getElementById('services'),
                permissions: document.getElementById('permissions'),
                messages: document.getElementById('messages')
            };
            
            // Tab buttons
            const tabButtons = {
                overview: document.getElementById('overview-tab'),
                objects: document.getElementById('objects-tab'),
                instances: document.getElementById('instances-tab'),
                classifications: document.getElementById('classifications-tab'),
                paths: document.getElementById('paths-tab'),
                tags: document.getElementById('tags-tab'),
                services: document.getElementById('services-tab'),
                permissions: document.getElementById('permissions-tab'),
                messages: document.getElementById('messages-tab')
            };
            
            let connectedTables = [];
            
            // Connect to database
            dbConnectForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('db-file');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('Please select a file');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                loading.style.display = 'block';
                
                fetch('/connect', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        loading.style.display = 'none';
                        return;
                    }
                    
                    // Update UI
                    connectedTables = data.tables;
                    dbInfo.innerHTML = `
                        <p>Connected to: <strong>${file.name}</strong></p>
                        <p>Available tables:</p>
                        <ul>
                            ${connectedTables.map(table => `<li>${table}</li>`).join('')}
                        </ul>
                    `;
                    
                    // Show tabs
                    reportTabs.style.display = 'block';
                    
                    // Load overview report
                    loadReport('overview');
                })
                .catch(error => {
                    alert('Error: ' + error);
                    loading.style.display = 'none';
                });
            });
            
            // Tab click handlers
            tabButtons.overview.addEventListener('click', () => loadReport('overview'));
            tabButtons.objects.addEventListener('click', () => loadReport('objects'));
            tabButtons.instances.addEventListener('click', () => loadReport('instances'));
            tabButtons.classifications.addEventListener('click', () => loadReport('classifications'));
            tabButtons.paths.addEventListener('click', () => loadReport('parentPaths'));
            tabButtons.tags.addEventListener('click', () => loadReport('tags'));
            tabButtons.services.addEventListener('click', () => loadReport('services'));
            tabButtons.permissions.addEventListener('click', () => loadReport('permissions'));
            tabButtons.messages.addEventListener('click', () => loadReport('messages'));
            
            // Load report data
            function loadReport(reportType) {
                loading.style.display = 'block';
                
                // Check if table exists
                if (reportType !== 'overview') {
                    let tableMap = {
                        'objects': 'objects',
                        'instances': 'instances',
                        'classifications': 'classifications',
                        'parentPaths': 'parentPaths',
                        'tags': 'tagSets',
                        'services': 'services',
                        'permissions': 'osPermissions',
                        'messages': 'messages'
                    };
                    
                    if (!connectedTables.includes(tableMap[reportType])) {
                        const element = tabsContent[reportType === 'parentPaths' ? 'paths' : reportType];
                        element.innerHTML = `
                            <div class="alert alert-warning">
                                The table ${tableMap[reportType]} does not exist in this database.
                            </div>
                        `;
                        loading.style.display = 'none';
                        return;
                    }
                }
                
                fetch(`/report/${reportType}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert('Error: ' + data.error);
                            loading.style.display = 'none';
                            return;
                        }
                        
                        // Render the report
                        const reportData = data.report;
                        
                        switch (reportType) {
                            case 'overview':
                                renderOverviewReport(reportData);
                                break;
                            case 'objects':
                                renderObjectsReport(reportData);
                                break;
                            case 'instances':
                                renderInstancesReport(reportData);
                                break;
                            case 'classifications':
                                renderClassificationsReport(reportData);
                                break;
                            case 'parentPaths':
                                renderPathsReport(reportData);
                                break;
                            case 'tags':
                                renderTagsReport(reportData);
                                break;
                            case 'services':
                                renderServicesReport(reportData);
                                break;
                            case 'permissions':
                                renderPermissionsReport(reportData);
                                break;
                            case 'messages':
                                renderMessagesReport(reportData);
                                break;
                        }
                        
                        loading.style.display = 'none';
                    })
                    .catch(error => {
                        alert('Error: ' + error);
                        loading.style.display = 'none';
                    });
            }
            
            // Render report functions
            function renderOverviewReport(data) {
                const element = tabsContent.overview;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Database Summary</h3>
                                <p><strong>Total Objects:</strong> ${data.total_objects.toLocaleString()}</p>
                                <p><strong>Total Instances:</strong> ${data.total_instances.toLocaleString()}</p>
                                <p><strong>Total Storage:</strong> ${data.total_storage}</p>
                                <p><strong>Date Range:</strong> ${data.date_range}</p>
                            </div>
                            
                            <div class="stats-box">
                                <h3>Table Row Counts</h3>
                                <ul>
                                    ${Object.entries(data.table_counts).map(([table, count]) => 
                                        `<li><strong>${table}:</strong> ${count.toLocaleString()}</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            ${data.relationship_stats ? `
                                <div class="stats-box">
                                    <h3>Relationship Summary</h3>
                                    <p><strong>Unique Objects:</strong> ${data.relationship_stats.unique_objects.toLocaleString()}</p>
                                    <p><strong>Unique Instances:</strong> ${data.relationship_stats.unique_instances.toLocaleString()}</p>
                                    <p><strong>Unique Parents:</strong> ${data.relationship_stats.unique_parents.toLocaleString()}</p>
                                    <p><strong>Unique Services:</strong> ${data.relationship_stats.unique_services.toLocaleString()}</p>
                                    <p><strong>Unique Classifications:</strong> ${data.relationship_stats.unique_classifications.toLocaleString()}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Database Table Sizes</h3>
                        <img src="data:image/png;base64,${data.table_counts_img}" class="img-fluid" alt="Table Counts">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderObjectsReport(data) {
                const element = tabsContent.objects;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Object Summary</h3>
                                <p><strong>Total Objects:</strong> ${data.total_objects.toLocaleString()}</p>
                                <p><strong>Unique File Extensions:</strong> ${data.unique_extensions.toLocaleString()}</p>
                                
                                <h4>Top File Extensions:</h4>
                                <ul>
                                    ${data.top_extensions.map(ext => 
                                        `<li><strong>${ext.ext}:</strong> ${ext.count.toLocaleString()} files</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            ${data.tag_distribution && data.tag_distribution.length > 0 ? `
                                <div class="stats-box">
                                    <h3>Tag Distribution</h3>
                                    <ul>
                                        ${data.tag_distribution.map(tag => 
                                            `<li><strong>${tag.tag_key || 'Unknown'}:</strong> ${tag.count.toLocaleString()}</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>File Extension Distribution</h3>
                        <img src="data:image/png;base64,${data.extension_dist_img}" class="img-fluid" alt="File Extensions">
                    </div>
                    
                    <div class="chart-container">
                        <h3>Object Creation Timeline</h3>
                        <img src="data:image/png;base64,${data.creation_timeline_img}" class="img-fluid" alt="Creation Timeline">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderInstancesReport(data) {
                const element = tabsContent.instances;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Size Statistics</h3>
                                <p><strong>Min Size:</strong> ${data.size_stats.min_size}</p>
                                <p><strong>Max Size:</strong> ${data.size_stats.max_size}</p>
                                <p><strong>Average Size:</strong> ${data.size_stats.avg_size}</p>
                                <p><strong>Median Size:</strong> ${data.size_stats.median_size}</p>
                                <p><strong>Total Storage:</strong> ${data.size_stats.total_storage}</p>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            ${data.service_distribution && data.service_distribution.length > 0 ? `
                                <div class="stats-box">
                                    <h3>Service Distribution</h3>
                                    <ul>
                                        ${data.service_distribution.map(service => 
                                            `<li><strong>${service.service_name || 'Unknown'}:</strong> ${service.instance_count.toLocaleString()} instances</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>File Size Distribution</h3>
                        <img src="data:image/png;base64,${data.size_dist_img}" class="img-fluid" alt="Size Distribution">
                    </div>
                    
                    <div class="chart-container">
                        <h3>Instance Creation and Size Over Time</h3>
                        <img src="data:image/png;base64,${data.creation_size_img}" class="img-fluid" alt="Creation and Size">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderClassificationsReport(data) {
                const element = tabsContent.classifications;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Classification Summary</h3>
                                <p><strong>Total Classifications:</strong> ${data.total_classifications.toLocaleString()}</p>
                                <p><strong>Unique Classification Sets:</strong> ${data.unique_sets.toLocaleString()}</p>
                                
                                <h4>Top Classification Sets:</h4>
                                <ul>
                                    ${data.top_sets.map(set => 
                                        `<li><strong>${set.classificationSet}:</strong> ${set.count.toLocaleString()} entries</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            ${data.classified_objects && data.classified_objects.length > 0 ? `
                                <div class="stats-box">
                                    <h3>Objects with Classifications</h3>
                                    <ul>
                                        ${data.classified_objects.map(obj => 
                                            `<li><strong>${obj.classificationSet}:</strong> ${obj.object_count.toLocaleString()} objects</li>`
                                        ).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Classification Sets Distribution</h3>
                        <img src="data:image/png;base64,${data.classification_sets_img}" class="img-fluid" alt="Classification Sets">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderPathsReport(data) {
                const element = tabsContent.paths;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Path Summary</h3>
                                <p><strong>Total Parent Paths:</strong> ${data.total_paths.toLocaleString()}</p>
                                <p><strong>Unique Parent IDs:</strong> ${data.unique_parents.toLocaleString()}</p>
                                
                                <h4>Top-level Path Categories:</h4>
                                <ul>
                                    ${data.top_paths.map(path => 
                                        `<li><strong>${path.top_level}:</strong> ${path.count.toLocaleString()} entries</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Path Depth Distribution</h3>
                        <img src="data:image/png;base64,${data.path_depth_img}" class="img-fluid" alt="Path Depth">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderTagsReport(data) {
                const element = tabsContent.tags;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Tag Sets Summary</h3>
                                <p><strong>Total Tag Sets:</strong> ${data.total_tag_sets.toLocaleString()}</p>
                                
                                <h4>Tag Sets:</h4>
                                <ul>
                                    ${data.tag_sets.map(set => 
                                        `<li><strong>${set.tagSet}:</strong> ${set.used_count.toLocaleString()} usages</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Tag Sets Usage</h3>
                        <img src="data:image/png;base64,${data.tag_sets_img}" class="img-fluid" alt="Tag Sets">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderServicesReport(data) {
                const element = tabsContent.services;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-12">
                            <div class="stats-box">
                                <h3>Services Summary</h3>
                                <p><strong>Total Services:</strong> ${data.total_services.toLocaleString()}</p>
                                
                                <h4>Service Details:</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Key</th>
                                            <th>Type</th>
                                            <th>Mode</th>
                                            <th>Access Delay</th>
                                            <th>Access Rate</th>
                                            <th>Access Cost</th>
                                            <th>Store Cost</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.services.map(service => `
                                            <tr>
                                                <td>${service.serviceId}</td>
                                                <td>${service.name}</td>
                                                <td>${service.key}</td>
                                                <td>${service.type}</td>
                                                <td>${service.mode}</td>
                                                <td>${service.accessDelay}</td>
                                                <td>${service.accessRate}</td>
                                                <td>${service.accessCost}</td>
                                                <td>${service.storeCost}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Service Types Distribution</h3>
                        <img src="data:image/png;base64,${data.service_types_img}" class="img-fluid" alt="Service Types">
                    </div>
                    
                    <div class="chart-container">
                        <h3>Service Usage</h3>
                        <img src="data:image/png;base64,${data.service_usage_img}" class="img-fluid" alt="Service Usage">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderPermissionsReport(data) {
                const element = tabsContent.permissions;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Permissions Summary</h3>
                                <p><strong>Total Permissions:</strong> ${data.total_permissions.toLocaleString()}</p>
                                <p><strong>Unique Permission Sets:</strong> ${data.unique_permission_sets.toLocaleString()}</p>
                                
                                <h4>Permission Sets:</h4>
                                <ul>
                                    ${data.permission_sets.map(set => 
                                        `<li><strong>${set.permissionSet}:</strong> ${set.count.toLocaleString()} entries</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="stats-box">
                                <h3>Security Summary</h3>
                                <p><strong>Total Security Entries:</strong> ${data.total_security_entries.toLocaleString()}</p>
                                
                                <h4>Security Authorities:</h4>
                                <ul>
                                    ${data.security_authorities.map(auth => 
                                        `<li><strong>${auth.authority}:</strong> ${auth.count.toLocaleString()} entries (${auth.group_count} groups, ${auth.local_count} local)</li>`
                                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Permission Sets Distribution</h3>
                        <img src="data:image/png;base64,${data.permission_sets_img}" class="img-fluid" alt="Permission Sets">
                    </div>
                    
                    <div class="chart-container">
                        <h3>Security Authorities</h3>
                        <img src="data:image/png;base64,${data.security_auth_img}" class="img-fluid" alt="Security Authorities">
                    </div>
                `;
                
                element.innerHTML = html;
            }
            
            function renderMessagesReport(data) {
                const element = tabsContent.messages;
                
                if (data.error) {
                    element.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                    return;
                }
                
                let html = `
                    <div class="row">
                        <div class="col-md-12">
                            <div class="stats-box">
                                <h3>Messages Summary</h3>
                                <p><strong>Total Messages:</strong> ${data.total_messages.toLocaleString()}</p>
                                
                                <h4>Sample Messages:</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>GUID</th>
                                            <th>Time</th>
                                            <th>Preview</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${data.sample_messages.map(msg => `
                                            <tr>
                                                <td>${msg.messageId}</td>
                                                <td>${msg.messageGuid}</td>
                                                <td>${msg.time}</td>
                                                <td>${msg.message_preview}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h3>Messages Over Time</h3>
                        <img src="data:image/png;base64,${data.messages_time_img}" class="img-fluid" alt="Messages Over Time">
                    </div>
                `;
                
                element.innerHTML = html;
            }
        });
    </script>
</body>
</html>
        